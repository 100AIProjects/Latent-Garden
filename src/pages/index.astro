---
/* src/pages/index.astro */
import BaseLayout from '../layouts/BaseLayout.astro';
import ForceGarden from '../components/ForceGarden.astro';
import SeedModal  from '../components/SeedModal.astro';
import ActiveNote from '../layouts/ActiveNote.astro';
import { getCollection } from 'astro:content';

const projects = await getCollection('garden');
const sorted = projects.sort((a, b) => {
    return new Date(b.data.date).valueOf() - new Date(a.data.date).valueOf();
});

// FEATURED: Top 15 Only
const featured = sorted.slice(0, 15);

const EMOJI_MAP = {
    'seedling': 'ðŸŒ±',
    'sapling': 'ðŸŒ¿',
    'evergreen': 'ðŸŒ²'
};
---

<BaseLayout>
    
    <header class="hero-section">
        <ForceGarden />
        <div class="hero-overlay">
            <h1 class="hero-title">The Latent Garden</h1>
            <p class="hero-subtitle">A place for ideas that aren't quite real yet. Watch a man and his Claude build a nursery in public. Enjoy the fruits. Take the blueprints. Tend the garden.
</p>
        </div>
        <a href="#" class="scroll-indicator" id="wander-cta">â†“ WANDER THE GARDEN</a>
    </header>

    <main class="container">
        
        {featured.map((project) => {
            const statusKey = project.data.status?.toLowerCase() || 'seedling';
            const emoji = EMOJI_MAP[statusKey] || 'ðŸŒ±';

            return (
            <article class="emerge-node group">
                <a href={`/${project.slug}`} style="text-decoration: none;">
                    <div class="node-header">
                        <div class="node-dot"></div>
                        <span class="node-status">{emoji} {project.data.status}</span>
                    </div>
                    <h2 class="node-title">{project.data.title}</h2>
                    <p class="node-desc">{project.data.description}</p>
                </a>
            </article>
            )
        })}

        <!-- MAP GATEWAY: Commented out until we have more nodes
        <div class="archive-gateway" style="text-align: center; margin-bottom: 20vh;">
            <a href="/map" class="emerge-node is-visible" style="text-decoration: none;">
                <h2 style="font-family: var(--font-head); font-weight: 700; font-size: 2rem; color: var(--ink);">
                    ...and {sorted.length - 15} more nodes in deep storage.
                </h2>
                <span style="font-family: var(--font-mono); font-size: 10px; border-bottom: 1px solid var(--moss); padding-bottom: 5px; color: var(--moss);">
                    ENTER_ARCHIVE_ROOM
                </span>
            </a>
        </div>
        -->

        <footer class="footer-soil">
            <div class="soil-divider"></div>
            
            <a href="/support" class="water-cta">
                Would you like to water the garden? ðŸª´
            </a>
            
            <div class="legals">
                <span>Â© 2026 100 AI PROJECTS</span>
                <a href="/tc">T&C</a>
                <a href="/privacy">Privacy</a>
            </div>
        </footer>

    </main>

    <div class="mist-overlay"></div>

    <!-- Peek interfaces: modal (latent nodes) + panel (active nodes) -->
    <SeedModal />
    <ActiveNote />

    <script>
        function armScrollReveal() {
            const targets = document.querySelectorAll('.emerge-node');
            if (targets.length === 0) return;

            // Strip .is-visible so the animation replays on every return visit
            targets.forEach(node => node.classList.remove('is-visible'));

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        requestAnimationFrame(() => entry.target.classList.add('is-visible'));
                        observer.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.15, rootMargin: "0px 0px -50px 0px" });

            targets.forEach(node => observer.observe(node));
        }

        // Arm the "WANDER THE GARDEN" scroll-to-first-node CTA
        function armWander() {
            const cta = document.getElementById('wander-cta');
            if (!cta) return;
            cta.addEventListener('click', (e) => {
                e.preventDefault();
                const first = document.querySelector('.emerge-node');
                if (!first) return;

                const target = first.getBoundingClientRect().top + window.scrollY - 80;
                const start = window.scrollY;
                const distance = target - start;
                const duration = 2400;
                let startTime = null;

                function ease(t) {
                    // Cubic ease-out: decelerates like mist receding
                    return 1 - Math.pow(1 - t, 3);
                }

                function step(timestamp) {
                    if (!startTime) startTime = timestamp;
                    const elapsed = timestamp - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    window.scrollTo(0, start + distance * ease(progress));
                    if (progress < 1) requestAnimationFrame(step);
                }

                requestAnimationFrame(step);
            });
        }

        // Run on hard load and on every view-transition navigation
        armScrollReveal();
        armWander();
        document.addEventListener('astro:page-load', () => {
            armScrollReveal();
            armWander();
        });
    </script>

</BaseLayout>

