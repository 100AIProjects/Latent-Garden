---
/* src/pages/003-token-usage.astro */
import BaseLayout from '../layouts/BaseLayout.astro';
import Wayfinder from '../components/Wayfinder.astro';
import { getCollection } from 'astro:content';
import { readFileSync } from 'fs';

// Fetch telemetry at build time
let lifetimeData = null;
let projectData = [];
let syncedAt = null;

try {
  const telemetry = JSON.parse(readFileSync('./public/telemetry.json', 'utf-8'));
  lifetimeData = telemetry.lifetime;
  projectData = telemetry.projects || [];
  syncedAt = telemetry.synced_at;
} catch (err) {
  console.error('‚ö†Ô∏è  Telemetry data unavailable:', err.message);
}

// Calculate prev/next for navigation (sorted by slug = project number order)
const allPosts = await getCollection('garden');
const sorted = allPosts.sort((a, b) => a.slug.localeCompare(b.slug));
const currentIndex = sorted.findIndex(p => p.slug === '003-token-usage');
const prevPost = currentIndex > 0 ? sorted[currentIndex - 1] : null;
const nextPost = currentIndex < sorted.length - 1 ? sorted[currentIndex + 1] : null;

// Format helpers
const fmt = (val) => val != null ? `$${val.toFixed(2)}` : '‚Äî';
const fmtTokens = (val) => val != null ? `${(val / 1000).toFixed(1)}K` : '‚Äî';
const fmtDate = (dateStr) => {
  if (!dateStr) return '‚Äî';
  try {
    return new Date(dateStr).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
  } catch {
    return dateStr;
  }
};
---

<BaseLayout>
  <article class="project-article">
    <Wayfinder title="003: Token Usage" parent="ROOT" />

    <header class="article-header">
      <h1 class="title">003: Token Usage</h1>
      <div class="meta">
        <span class="date">{new Date('2026-02-04').toLocaleDateString()}</span>
        <span class="status-tag sapling">sapling</span>
      </div>
    </header>

    <div class="content-body">

      <h2>The Garden's Metabolic Ledger</h2>
      <p>
        Every node in this garden is the result of a <strong>Metabolic Exchange</strong>.
        The system consumes tokens to nurture new projects, fragments, and weed the garden of bugs.
        This project makes that consumption transparent, turning the invisible cost of compute
        into a visible data fragment.
      </p>

      <p>
        The home page shows this metabolic exchange: nodes glow from green (low cost) to amber
        (high cost); while dormant nodes are grey. Watering the garden directly offsets the
        "Metabolic Debt."
      </p>

      <h2>1. Lifetime Metrics</h2>
      {lifetimeData ? (
        <>
          <table>
            <thead>
              <tr>
                <th>Metric</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Total Sessions</td>
                <td>{lifetimeData.total_sessions || 0}</td>
              </tr>
              <tr>
                <td>Lifetime Tokens</td>
                <td>{fmtTokens(lifetimeData.lifetime_tokens)}</td>
              </tr>
              <tr>
                <td>Total Cost</td>
                <td><span class="currency">{fmt(lifetimeData.lifetime_cost)}</span></td>
              </tr>
              <tr>
                <td>Avg Efficiency</td>
                <td>{lifetimeData.avg_efficiency?.toFixed(1) || '‚Äî'} tokens/unit</td>
              </tr>
              <tr>
                <td>Project Count</td>
                <td>{lifetimeData.project_count || 0}</td>
              </tr>
              <tr>
                <td>Journey Start</td>
                <td>{fmtDate(lifetimeData.journey_start)}</td>
              </tr>
              <tr>
                <td>Latest Activity</td>
                <td>{fmtDate(lifetimeData.latest_activity)}</td>
              </tr>
            </tbody>
          </table>
          {syncedAt && (
            <p style="font-family: var(--font-mono); font-size: 10px; opacity: 0.5; margin-top: 1rem;">
              Last synced: {fmtDate(syncedAt)}
            </p>
          )}
        </>
      ) : (
        <p><em>Telemetry data unavailable (D1 sync pending)</em></p>
      )}

      <h2>2. Per-Project Breakdown</h2>
      {projectData.length > 0 ? (
        <table>
          <thead>
            <tr>
              <th>Project</th>
              <th>Sessions</th>
              <th>Tokens</th>
              <th>Cost</th>
              <th>Efficiency</th>
            </tr>
          </thead>
          <tbody>
            {projectData.map(p => (
              <tr>
                <td>{p.project_name}</td>
                <td>{p.session_count || 0}</td>
                <td>{fmtTokens(p.total_tokens)}</td>
                <td><span class="currency">{fmt(p.total_cost)}</span></td>
                <td>{p.avg_efficiency?.toFixed(1) || '‚Äî'}</td>
              </tr>
            ))}
          </tbody>
        </table>
      ) : (
        <p><em>No project data synced yet.</em></p>
      )}

    </div>
  </article>

  <nav class="project-nav">
    {prevPost ? (
      <a href={`/${prevPost.slug}`} class="nav-arrow nav-prev">
        <span class="nav-arrow-symbol">‚Üê</span>
        <span class="nav-label">{prevPost.data.title}</span>
      </a>
    ) : (
      <a href="/001-about-the-garden" class="nav-arrow nav-prev nav-boundary">
        <span class="nav-arrow-symbol">‚Üê</span>
        <span class="nav-label">Start of Garden</span>
      </a>
    )}

    <a href="/archive" class="nav-center">
      <span class="nav-label">INDEX</span>
    </a>

    {nextPost ? (
      <a href={`/${nextPost.slug}`} class="nav-arrow nav-next">
        <span class="nav-label">{nextPost.data.title}</span>
        <span class="nav-arrow-symbol">‚Üí</span>
      </a>
    ) : (
      <a href={`/${sorted[sorted.length - 1].slug}`} class="nav-arrow nav-next nav-boundary">
        <span class="nav-label">End of Garden</span>
        <span class="nav-arrow-symbol">‚Üí</span>
      </a>
    )}
  </nav>

  <footer class="footer-soil">
    <div class="soil-divider"></div>
    <a href="/support" class="water-cta">
      Would you like to water the garden? ü™¥
    </a>
    <div class="legals">
      <span>¬© 2026 100 AI PROJECTS</span>
      <a href="/tc">T&C</a>
      <a href="/privacy">Privacy</a>
    </div>
  </footer>
</BaseLayout>

<style>
  /* Match project-nav styles from [...slug].astro */
  .project-nav {
    max-width: var(--width);
    margin: 0 auto;
    padding: 4rem 0;
    border-top: 1px solid var(--border);
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 2rem;
    align-items: center;
  }

  .nav-arrow {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-family: var(--font-mono);
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--moss);
    text-decoration: none;
    opacity: 0.7;
    transition: opacity 0.3s, transform 0.3s;
  }

  .nav-prev { justify-content: flex-start; }
  .nav-next { justify-content: flex-end; }

  .nav-arrow:hover { opacity: 1; }
  .nav-prev:hover { transform: translateX(-5px); }
  .nav-next:hover { transform: translateX(5px); }

  .nav-boundary { opacity: 0.4; }
  .nav-boundary:hover { opacity: 0.7; }

  .nav-arrow-symbol { font-size: 14px; font-weight: 700; }

  .nav-center {
    font-family: var(--font-mono);
    font-size: 10px;
    letter-spacing: 0.2em;
    color: var(--ink-dim);
    text-decoration: none;
    padding: 8px 16px;
    border: 1px solid var(--border);
    transition: border-color 0.3s, color 0.3s;
  }

  .nav-center:hover {
    border-color: var(--moss);
    color: var(--moss);
  }

  .nav-label {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  @media (max-width: 600px) {
    .project-nav {
      grid-template-columns: 1fr;
      text-align: center;
      gap: 1.5rem;
    }
    .nav-prev, .nav-next { justify-content: center; }
  }
</style>
